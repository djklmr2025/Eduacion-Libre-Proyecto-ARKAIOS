<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantilla para Tareas Escolares â€” Carta MX</title>
  <style>
    /* Reset bÃ¡sico */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Hoja Carta Mexicana explÃ­cita (21.59 x 27.94 cm) */
    @page {
      size: 21.59cm 27.94cm;
      margin: 1.9cm;
    }

    @media print {
      @page {
        size: 21.59cm 27.94cm;
        margin: 1.9cm;
      }

      /* Colores y proporciones tal cual */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      html,
      body {
        margin: 0 !important;
        padding: 0 !important;
        width: 21.59cm !important;
        height: auto !important;
        overflow: visible !important;
      }

      header,
      footer,
      .toolbar,
      .instructions {
        display: none !important;
      }

      .page-container {
        box-shadow: none !important;
        margin: 0;
        page-break-after: always;
        page-break-inside: avoid;
        width: 100% !important;
        min-height: auto !important;
        height: auto !important;
        overflow: visible !important;
      }

      .page-container:last-child {
        page-break-after: auto;
      }

      /* Quitar contornos visuales en impresiÃ³n */
      .field-input,
      .references-input,
      .text-block,
      .image-slot {
        border: none !important;
        background: white !important;
      }

      /* Evitar recortes de contenido en impresiÃ³n */
      .references-wrap,
      .text-block {
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
      }

      .text-block .content,
      #referencesInput {
        height: auto !important;
        overflow: visible !important;
      }

      .image-slot .placeholder,
      .image-slot .add-btn,
      .image-slot .remove-btn,
      .image-slot .drag-handle {
        display: none !important;
      }

      .image-slot:not(.has-image) {
        display: none;
      }
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }

    .toolbar {
      background: #2c3e50;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      color: #fff;
    }

    .toolbar button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
    }

    .toolbar button.success {
      background: #27ae60;
    }

    .toolbar button.danger {
      background: #e74c3c;
    }

    .toolbar select {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
    }

    .page-container {
      background: #fff;
      width: 21.59cm;
      min-height: 27.94cm;
      margin: 0 auto 28px;
      padding: 1.9cm;
      box-shadow: 0 0 20px rgba(0, 0, 0, .18);
      position: relative;
    }

    /* HOJA 1 - ÃNDICE */
    .index-title {
      text-align: center;
      margin-bottom: 0.9cm;
      padding-bottom: 12px;
      border-bottom: 3px solid #2c3e50;
    }

    .index-title h1 {
      font-size: 24pt;
      color: #2c3e50;
    }

    .index-fields {
      display: grid;
      gap: 12px;
      margin-bottom: 14px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 12px;
      align-items: center;
    }

    .field-label {
      font-weight: 700;
      color: #2c3e50;
      font-size: 12pt;
      text-align: right;
      padding: 8px;
      background: #ecf0f1;
      border-radius: 6px;
    }

    .field-input {
      border: 2px solid #95a5a6;
      padding: 10px;
      font-size: 11pt;
      border-radius: 6px;
      background: #f9f9f9;
      outline: none;
    }

    .field-input.filled {
      border-color: #27ae60;
      background: #fff;
    }

    .references-section {
      display: flex;
      flex-direction: column;
      border-top: 2px solid #bdc3c7;
      padding-top: 14px;
    }

    .references-section h3 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 14pt;
    }

    .references-wrap {
      border: 2px solid #95a5a6;
      border-radius: 6px;
      background: #f9f9f9;
      overflow: hidden;
    }

    .references-input {
      padding: 14px;
      font-size: 10.5pt;
      line-height: 1.55;
      outline: none;
      height: 100%;
      overflow: auto;
    }

    .references-input a {
      color: #0066cc;
      text-decoration: underline;
    }

    /* HOJA 2 - TEXTO */
    .page-header {
      text-align: center;
      margin-bottom: 0.4cm;
      padding-bottom: 12px;
      border-bottom: 3px solid #8b4513;
    }

    .page-header h1 {
      font-size: 20pt;
      color: #2c3e50;
    }

    .page-header .subtitle {
      font-size: 12pt;
      color: #7f8c8d;
      font-style: italic;
    }

    /* Nuevo: cajita de tema/subtema */
    .topic-box {
      margin: 0.4cm 0 0.6cm;
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      align-items: center;
    }

    .topic-label {
      font-weight: 700;
      color: #2c3e50;
      text-align: right;
      padding: 6px 8px;
      background: #ecf0f1;
      border-radius: 6px;
    }

    .topic-input {
      border: 2px solid #95a5a6;
      border-radius: 6px;
      padding: 8px 10px;
      background: #f9f9f9;
      min-height: 1.2em;
      outline: none;
    }

    .topic-input.filled {
      border-color: #27ae60;
      background: #fff;
    }

    .text-page {
      display: flex;
      flex-direction: column;
      gap: 0.6cm;
    }

    .text-block {
      border: 2px dashed #95a5a6;
      background: #f9f9f9;
      padding: 16px;
      min-height: 17cm;
      /* un solo cuadro grande */
      border-radius: 8px;
      page-break-inside: avoid;
      overflow: hidden;
    }

    .text-block.has-content {
      border-color: #27ae60;
      background: #fff;
    }

    .text-block .content {
      text-align: justify;
      line-height: 1.6;
      color: #2c3e50;
      outline: none;
      font-size: 1em;
    }

    .text-block .content h2 {
      color: #8b4513;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 2px solid #d2691e;
      font-size: 1.2em;
    }

    .text-block .content p {
      margin-bottom: 10px;
    }

    .text-block .content sup {
      color: #e74c3c;
      font-weight: 700;
    }

    /* HOJA 3 - IMÃGENES (solo imÃ¡genes) */
    .image-page {
      display: grid;
      gap: 0.6cm;
    }

    .image-page.grid-3 {
      grid-template-columns: 1fr;
    }

    .image-page.grid-6 {
      grid-template-columns: repeat(2, 1fr);
    }

    .image-page.grid-9 {
      grid-template-columns: repeat(3, 1fr);
    }

    .image-page.grid-12 {
      grid-template-columns: repeat(3, 1fr);
    }

    /* Alturas segÃºn cantidad para que quepan mejor en la hoja */
    .image-page.grid-3 .image-slot {
      min-height: 7cm;
    }

    .image-page.grid-6 .image-slot {
      min-height: 6cm;
    }

    .image-page.grid-9 .image-slot {
      min-height: 5cm;
    }

    .image-page.grid-12 .image-slot {
      min-height: 4.2cm;
    }

    .image-slot {
      border: 3px dashed #95a5a6;
      background: #ecf0f1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: move;
      transition: .2s;
      overflow: hidden;
    }

    .image-slot.has-image {
      border-style: solid;
      border-color: #27ae60;
      background: #fff;
    }

    .image-slot img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .image-slot .add-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #3498db;
      color: #fff;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 0;
      font-size: 30px;
      font-weight: 700;
    }

    .image-slot.has-image .add-btn {
      display: none;
    }

    .image-slot .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #e74c3c;
      color: #fff;
      border: 0;
      font-weight: 700;
      display: none;
    }

    .image-slot.has-image .remove-btn {
      display: block;
    }

    .image-slot .drag-handle {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(52, 152, 219, .9);
      color: #fff;
      padding: 4px 12px;
      border-radius: 14px;
      font-size: 10pt;
      display: none;
    }

    .image-slot.has-image .drag-handle {
      display: block;
    }

    .instructions {
      background: #fff9e6;
      border-left: 4px solid #f39c12;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
    }

    /* Modo impresiÃ³n sin cambiar tamaÃ±os de letra */
    .print-mode .text-block .content,
    .print-mode #referencesInput {
      font-size: inherit !important;
    }
  </style>
</head>

<body>
  <!-- BARRA DE HERRAMIENTAS -->
  <div class="toolbar">
    <button class="success" onclick="window.print()">ðŸ–¨ï¸ Imprimir</button>
    <span>ImÃ¡genes por hoja:</span>
    <select id="imageLayout" onchange="changeImageLayout()">
      <option value="3">3 imÃ¡genes</option>
      <option value="6">6 imÃ¡genes</option>
      <option value="9">9 imÃ¡genes</option>
      <option value="12">12 imÃ¡genes</option>
    </select>
    <button onclick="document.getElementById('bulkFileInput').click()">ðŸ“ Cargar ImÃ¡genes</button>
    <input type="file" id="bulkFileInput" multiple accept="image/*" style="display:none"
      onchange="loadBulkImages(event)">
    <button class="danger" onclick="clearAllImages()">ðŸ—‘ï¸ Limpiar ImÃ¡genes</button>

    <!-- Botones Generales -->
    <button onclick="searchPexels()" style="background: #05a081;">ðŸ“¸ Pexels</button>
    <button onclick="searchFreepik()" style="background: #336aea;">ðŸŽ¨ Freepik</button>
    <button onclick="openAIModal()" style="background: #8e44ad;">âœ¨ Crear con IA</button>
  </div>

  <!-- HOJA 1: ÃNDICE -->
  <div class="page-container" id="page1">
    <div class="index-title">
      <h1>ÃNDICE</h1>
    </div>

    <div class="index-fields">
      <div class="field-row">
        <div class="field-label" contenteditable="true" onblur="ensureLabel(this)">Nombre:</div>
        <input class="field-input" id="field0" placeholder="Tu nombre" oninput="checkFilled(this)">
      </div>
      <div class="field-row">
        <div class="field-label" contenteditable="true" onblur="ensureLabel(this)">Materia:</div>
        <input class="field-input" id="field1" placeholder="Materia" oninput="checkFilled(this)">
      </div>
      <div class="field-row">
        <div class="field-label" contenteditable="true" onblur="ensureLabel(this)">Profesor(a):</div>
        <input class="field-input" id="field2" placeholder="Profesor(a)" oninput="checkFilled(this)">
      </div>
      <div class="field-row">
        <div class="field-label" contenteditable="true" onblur="ensureLabel(this)">Fecha:</div>
        <input class="field-input" id="field3" placeholder="DD/MM/AAAA" oninput="checkFilled(this)">
      </div>
      <div class="field-row">
        <div class="field-label" contenteditable="true" onblur="ensureLabel(this)">Tema:</div>
        <input class="field-input" id="fieldTopic" placeholder="Se auto-completa" readonly>
      </div>
    </div>

    <div class="references-section">
      <h3>Referencias y Fuentes Consultadas</h3>
      <div class="references-wrap" id="refsWrap">
        <div class="references-input" id="referencesInput" contenteditable="true"
          oninput="detectLinks(); fitToHeight('#referencesInput', {min:9,max:12,step:.5});"
          onpaste="handleReferencePaste(event)">
          Pega aquÃ­ tus referencias bibliogrÃ¡ficas y enlaces webâ€¦
        </div>
      </div>
    </div>
  </div>

  <!-- HOJA 2: TEXTO -->
  <div class="page-container" id="page2">
    <div class="page-header">
      <h1 id="mainTitle" contenteditable="true" oninput="updateTopic()">CelebraciÃ³n del DÃ­a de Muertos en Pueblos
        IndÃ­genas de MÃ©xico</h1>
      <div class="subtitle" contenteditable="true">PurÃ©pechas, Mazahuas y Huastecos</div>
    </div>

    <!-- Nuevo: cajita pequeÃ±a de tema/subtema -->
    <div class="topic-box">
      <div class="topic-label">Subtema:</div>
      <div class="topic-input" id="topicInput" contenteditable="true" oninput="checkTopicFilled()">Los PurÃ©pechas</div>
    </div>

    <div class="text-page">
      <div class="text-block has-content" id="textBlockMain">
        <div class="content" contenteditable="true"
          oninput="markHasContent(this); fitToHeight('#textBlockMain', {min:9,max:16});">
          <h2>Desarrollo</h2>
          <p>Para las comunidades purÃ©pechas de MichoacÃ¡n, la celebraciÃ³n del DÃ­a de Muertos es conocida como
            <em>Animeecheri KÃºinchekua</em>, que significa "Fiesta de las Ãnimas". Esta tradiciÃ³n no es una
            celebraciÃ³n
            a la muerte, sino a la vida continuada o "la otra vida"â€¦<sup>1</sup>
          </p>
          <p>Los purÃ©pechas afirman que cuando alguien muere, su cuerpo se sepulta, pero su alma sigue
            viviendoâ€¦<sup>2</sup></p>
          <p>Uno de los elementos que distingue esta celebraciÃ³n son los grandes altaresâ€¦<sup>3</sup> â€¦leyenda que
            cuenta que estas mariposas son las almas que regresanâ€¦<sup>4</sup></p>
          <p>La comunidad mazahua, ubicada principalmente en el Estado de MÃ©xico y MichoacÃ¡nâ€¦<sup>5</sup>
            â€¦pÃ©talos del
            cempasÃºchilâ€¦<sup>6</sup> â€¦copalâ€¦<sup>7</sup></p>
          <p>En la regiÃ³n Huasteca se celebra el <em>Xantolo</em>, una festividad que se extiende del 30 de octubre al
            2
            de noviembreâ€¦<sup>10</sup> â€¦con danzas tradicionales conocidas como "vinuetes".<sup>11</sup></p>
        </div>
      </div>
    </div>
  </div>

  <!-- HOJA 3: IMÃGENES (sin cuadros de texto, solo imÃ¡genes) -->
  <div class="page-container" id="page3">
    <div class="page-header">
      <h1>ImÃ¡genes Representativas</h1>
      <div class="subtitle">Tradiciones del DÃ­a de Muertos</div>
    </div>

    <div class="image-page grid-3" id="imagePage"></div>
  </div>

  <!-- Modal IA -->
  <div id="aiModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div
      style="background: #1f2937; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid #3b82f6;">
      <h3 style="color: #3b82f6; margin-bottom: 15px;">âœ¨ Generar Imagen con Grok</h3>

      <div style="margin-bottom: 15px;">
        <label style="display: block; color: #e5e7eb; margin-bottom: 5px;">Tu API Key de Grok (xAI):</label>
        <input type="password" id="grokKey" placeholder="xai-..."
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #4b5563; background: #374151; color: white;">
        <small style="color: #9ca3af;">Se guardarÃ¡ localmente en tu navegador.</small>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; color: #e5e7eb; margin-bottom: 5px;">Describe tu imagen:</label>
        <textarea id="aiPrompt" rows="4" placeholder="Un paisaje espacial con planetas coloridos..."
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #4b5563; background: #374151; color: white;"></textarea>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; color: #e5e7eb; margin-bottom: 5px;">NÃºmero de imÃ¡genes:</label>
        <input type="number" id="imageCount" min="1" max="4" value="1"
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #4b5563; background: #374151; color: white;">
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeAIModal()"
          style="background: #4b5563; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Cancelar</button>
        <button onclick="generateAIImage()"
          style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Generar
          con Grok</button>
      </div>

      <div id="aiStatus" style="margin-top: 10px; color: #e5e7eb; font-size: 0.9rem;"></div>
    </div>
  </div>

  <script>
    /* ===== Utilidades ===== */
    function checkFilled(input) {
      input.value.trim()
        ? input.classList.add('filled')
        : input.classList.remove('filled');
    }

    function ensureLabel(node) {
      const t = node.innerText.trim();
      if (!t.endsWith(':')) node.innerText = t + ':';
    }

    function markHasContent(el) {
      const box = el.closest('.text-block');
      if (box) box.classList.add('has-content');
    }

    function updateTopic() {
      const title = document.getElementById('mainTitle').innerText.trim();
      const topic = document.getElementById('fieldTopic');
      topic.value = title;
      checkFilled(topic);
    }

    function checkTopicFilled() {
      const el = document.getElementById('topicInput');
      if (!el) return;
      const t = el.innerText.trim();
      t ? el.classList.add('filled') : el.classList.remove('filled');
    }

    // Detectar URLs pegadas en referencias y convertirlas a <a>
    function detectLinks() {
      const ref = document.getElementById('referencesInput');
      const html = ref.innerHTML;
      const url = /\b(https?:\/\/[^\s<]+)/g;
      const updated = html.replace(url, (u) =>
        html.includes(`<a href="${u}"`) ? u : `<a href="${u}" target="_blank">${u}</a>`
      );
      if (updated !== html) {
        ref.innerHTML = updated;
        placeCaretAtEnd(ref);
      }
    }

    function handleReferencePaste() {
      setTimeout(detectLinks, 80);
    }

    function placeCaretAtEnd(el) {
      el.focus();
      if (typeof window.getSelection != 'undefined' && typeof document.createRange != 'undefined') {
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    /* ===== Autoajuste de texto con mÃ¡rgenes fijos ===== */
    function fitToHeight(selector, opts) {
      const options = Object.assign({ min: 9, max: 16, step: 0.5 }, opts || {});
      const box = document.querySelector(selector);
      if (!box) return;

      const container = box.classList.contains('content') ? box.parentElement : box;
      const target = container;
      const inner = target.querySelector('.content') || target;

      let size = options.max;
      inner.style.fontSize = size + 'pt';

      for (let i = 0; i < 60; i++) {
        if (target.scrollHeight <= target.clientHeight + 1) break;
        size -= options.step;
        if (size <= options.min) {
          size = options.min;
          break;
        }
        inner.style.fontSize = size + 'pt';
      }
    }

    // Calcular altura mÃ¡xima para referencias en Hoja 1
    function sizeReferencesBox() {
      const page = document.getElementById('page1');
      const wrap = document.getElementById('refsWrap');
      const titleH = page.querySelector('.index-title').offsetHeight;
      const fieldsH = page.querySelector('.index-fields').offsetHeight;
      const secHeadH = page.querySelector('.references-section h3').offsetHeight;
      const pageInnerH = page.clientHeight;
      const paddingFix = 18;
      const maxH = pageInnerH - (titleH + fieldsH + secHeadH + 40 + paddingFix);
      wrap.style.maxHeight = Math.max(160, maxH) + 'px';
      fitToHeight('#referencesInput', { min: 9, max: 12, step: .5 });

      changeImageLayout();
      updateTopic();
      sizeReferencesBox();
      fitAll();
      checkTopicFilled();
    }););
    }

    /* ===== ImÃ¡genes: slots y drag ===== */
    const imageSlots = {};
    let selectedSlot = null;
    let draggedSlot = null;

    function createImageSlots(count) {
      const imagePage = document.getElementById('imagePage');
      imagePage.innerHTML = '';
      const titles = [
        'PurÃ©pechas',
        'Mazahuas',
        'Huastecos',
        'Imagen 4',
        'Imagen 5',
        'Imagen 6',
        'Imagen 7',
        'Imagen 8',
        'Imagen 9',
        'Imagen 10',
        'Imagen 11',
        'Imagen 12'
      ];

      for (let i = 0; i < count; i++) {
        const slot = document.createElement('div');
        slot.className = 'image-slot';
        slot.dataset.index = i;
        slot.draggable = false;

        const saved = imageSlots[i];
        if (saved) {
          slot.classList.add('has-image');
          slot.draggable = true;
          slot.innerHTML = `
            <img src="${saved}" alt="${titles[i] || ('Imagen ' + (i + 1))}">
            <button class='remove-btn' onclick='removeImage(${i}, event)'>âœ•</button>
            <div class='drag-handle'>â†•ï¸ Arrastrar</div>`;
        } else {
          slot.innerHTML = `
            <button class='add-btn' onclick='addImageToSlot(${i})'>+</button>
            <input type='file' id='fileInput${i}' accept='image/*' style='display:none'
                   onchange='loadSingleImage(${i}, event)'>`;
        }

        slot.addEventListener('click', () => { selectedSlot = i; });
        slot.addEventListener('dragstart', handleDragStart);
        slot.addEventListener('dragover', handleDragOver);
        slot.addEventListener('drop', handleDrop);
        slot.addEventListener('dragend', handleDragEnd);

        imagePage.appendChild(slot);
      }
    }

    function changeImageLayout() {
      const layout = parseInt(document.getElementById('imageLayout').value, 10);
      const page = document.getElementById('imagePage');
      page.className = `image-page grid-${layout}`;
      createImageSlots(layout);
    }

    function addImageToSlot(i) {
      document.getElementById(`fileInput${i}`).click();
    }

    function loadSingleImage(i, e) {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = (ev) => {
        imageSlots[i] = ev.target.result;
        changeImageLayout();
      };
      r.readAsDataURL(f);
    }

    function loadBulkImages(e) {
      const files = Array.from(e.target.files);
      const layout = parseInt(document.getElementById('imageLayout').value, 10);
      files.slice(0, layout).forEach((f, idx) => {
        const r = new FileReader();
        r.onload = (ev) => {
          imageSlots[idx] = ev.target.result;
          if (idx === Math.min(files.length, layout) - 1) changeImageLayout();
        };
        r.readAsDataURL(f);
      });
    }

    function clearAllImages() {
      if (confirm('¿Eliminar todas las imágenes?')) {
        Object.keys(imageSlots).forEach(k => delete imageSlots[k]);
        changeImageLayout();
      }
    }

    function removeImage(i, ev) {
      ev.stopPropagation();
      delete imageSlots[i];
      changeImageLayout();
    }

    // Drag & drop
    function handleDragStart(e) {
      draggedSlot = parseInt(this.dataset.index, 10);
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDrop(e) {
      e.stopPropagation();
      const target = parseInt(this.dataset.index, 10);
      if (draggedSlot === target) return;
      const tmp = imageSlots[draggedSlot];
      imageSlots[draggedSlot] = imageSlots[target];
      imageSlots[target] = tmp;
      changeImageLayout();
    }

    function handleDragEnd() {
      this.classList.remove('dragging');
    }

    // Pegado directo de imágenes al slot seleccionado
    document.addEventListener('paste', (e) => {
      if (selectedSlot === null) return;
      const items = e.clipboardData.items;
      for (const it of items) {
        if (it.type.indexOf('image') !== -1) {
          const blob = it.getAsFile();
          const r = new FileReader();
          r.onload = (ev) => {
            imageSlots[selectedSlot] = ev.target.result;
            changeImageLayout();
          };
          r.readAsDataURL(blob);
          break;
        }
      }
    });

    /* ===== Eventos de impresión ===== */
    function fitAll() {
      sizeReferencesBox();
      fitToHeight('#textBlockMain', { min: 9, max: 16 });
    }

    window.addEventListener('resize', () => {
      sizeReferencesBox();
      fitAll();
    });

    function enterPrintMode() {
      document.body.classList.add('print-mode');
    }

    function exitPrintMode() {
      document.body.classList.remove('print-mode');
    }

    if (window.matchMedia) {
      const mql = window.matchMedia('print');
      mql.addListener((mq) => {
        if (mq.matches) enterPrintMode();
        else exitPrintMode();
      });
    }

    window.onbeforeprint = enterPrintMode;
    window.onafterprint = exitPrintMode;

    /* ===== Init ===== */
    window.addEventListener('load', () => {
      // Fecha actual
      const today = new Date();
      const d = String(today.getDate()).padStart(2, '0');
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const y = today.getFullYear();
      const dateField = document.getElementById('field3');
      dateField.value = `${d}/${m}/${y}`;
      checkFilled(dateField);
      const fieldsH = page.querySelector('.index-fields').offsetHeight;
      const secHeadH = page.querySelector('.references-section h3').offsetHeight;
      const pageInnerH = page.clientHeight;
      const paddingFix = 18;
      const maxH = pageInnerH - (titleH + fieldsH + secHeadH + 40 + paddingFix);
      wrap.style.maxHeight = Math.max(160, maxH) + 'px';
      fitToHeight('#referencesInput', { min: 9, max: 12, step: .5 });
    }




    // ===== API KEYS & INTEGRATION =====
    const PEXELS_API_KEY = '4vj6qTzLM9oc0gN7bdgr3vCO7jRDIBe0zJgknfq9geibx9hdQ16TVxpz';
    const FREEPIK_API_KEY = 'FPSX890e70b7164ab7a1b05182a68d64ad06';

    function applyExternalImages(urls, sourceName) {
      const layout = parseInt(document.getElementById('imageLayout').value, 10);
      let currentUrlIdx = 0;

      for (let i = 0; i < layout; i++) {
        if (!imageSlots[i] && currentUrlIdx < urls.length) {
          imageSlots[i] = urls[currentUrlIdx];
          currentUrlIdx++;
        }
      }
      changeImageLayout();
      mostrarCreditoPixabay(sourceName, urls.length);
    }

    async function searchPexels() {
      const query = prompt("¿Qué imágenes buscas en Pexels?");
      if (!query) return;

      try {
        const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=12`, {
          headers: { Authorization: PEXELS_API_KEY }
        });
        const data = await response.json();
        const images = data.photos.map(photo => photo.src.large);
        applyExternalImages(images, `Pexels: ${query}`);
      } catch (error) {
        console.error(error);
        alert('Error al buscar en Pexels');
      }
    }

    async function searchFreepik() {
      const query = prompt("¿Qué imágenes buscas en Freepik?");
      if (!query) return;

      try {
        const response = await fetch(`https://api.freepik.com/v1/resources?locale=es-ES&q=${encodeURIComponent(query)}&limit=12`, {
          headers: { 'X-Freepik-API-Key': FREEPIK_API_KEY }
        });
        const data = await response.json();
        const images = data.data.map(item => item.image.source.url);
        applyExternalImages(images, `Freepik: ${query}`);
      } catch (error) {
        console.error(error);
        alert('Error al buscar en Freepik');
      }
    }

    // ===== AI GENERATION =====
    function openAIModal() {
      const storedKey = localStorage.getItem('grok_api_key');
      if (storedKey) document.getElementById('grokKey').value = storedKey;
      document.getElementById('aiModal').style.display = 'flex';
    }

    function closeAIModal() {
      document.getElementById('aiModal').style.display = 'none';
      document.getElementById('aiStatus').textContent = '';
    }

    async function generateAIImage() {
      const apiKey = document.getElementById('grokKey').value.trim();
      const prompt = document.getElementById('aiPrompt').value.trim();
      const count = parseInt(document.getElementById('imageCount').value) || 1;
      const statusDiv = document.getElementById('aiStatus');

      if (!apiKey) {
        alert('Por favor ingresa tu API Key de Grok (xAI)');
        return;
      }
      if (!prompt) {
        alert('Por favor describe la imagen');
        return;
      }

      localStorage.setItem('grok_api_key', apiKey);
      statusDiv.textContent = 'â³ Generando imÃ¡genes con Grok... (esto puede tomar unos segundos)';

      // Usar el backend proxy para evitar CORS
      const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:';
      const localBase = location.protocol === 'file:' ? 'http://localhost:3000' : location.origin;
      const endpoint = isLocal ? (localBase + '/api/grok') : '/api/grok';

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            apiKey: apiKey,
            prompt: prompt,
            count: count
          })
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData.error || response.statusText);
        }

        const data = await response.json();
        const content = data.choices[0]?.message?.content || '';

        // Buscar URLs en la respuesta
        const urlRegex = /(https?:\/\/[^\s)]+)/g;
        const matches = content.match(urlRegex);

        if (!matches || matches.length === 0) {
          throw new Error('Grok no devolviÃ³ URLs de imÃ¡genes. Respuesta: ' + content.substring(0, 100) + '...');
        }

        const imageUrls = matches.slice(0, count);
        applyExternalImages(imageUrls, `Grok: ${prompt}`);
        closeAIModal();

      } catch (error) {
        console.error(error);
        statusDiv.textContent = 'âŒ Error: ' + error.message;
      }
    }

    function mostrarCreditoPixabay(topic, count) {
      let credit = document.getElementById('pixabay-credit');
      if (!credit) {
        credit = document.createElement('div');
        credit.id = 'pixabay-credit';
        credit.style.cssText = 'margin: 10px; padding: 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; text-align: center; color: #0369a1; font-size: 0.9rem;';
        credit.classList.add('no-print');
        const toolbar = document.querySelector('.toolbar');
        if (toolbar) toolbar.parentNode.insertBefore(credit, toolbar.nextSibling);
      }
      const cleanTopic = topic || 'Pixabay';
      credit.textContent = `ImÃ¡genes de Pixabay (${count}) Â· Tema: ${cleanTopic}`;
    }
  </script>
</body>

</html>