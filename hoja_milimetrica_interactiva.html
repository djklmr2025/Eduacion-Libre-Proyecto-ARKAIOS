<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hoja Milim√©trica Interactiva - Plantilla Oficial</title>
  <style>
    @page {
      size: letter;
      margin: 0;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .toolbar {
      background: rgba(255, 255, 255, 0.98);
      padding: 12px 20px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      z-index: 100;
    }
    
    .toolbar h1 {
      font-size: 1.3em;
      color: #333;
      margin: 0;
    }
    
    .tools {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .tool-group {
      display: flex;
      gap: 5px;
      padding: 5px 8px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      background: white;
      color: #333;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 500;
    }
    
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    
    button.active {
      background: #667eea;
      color: white;
    }
    
    input[type="color"] {
      width: 45px;
      height: 32px;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }
    
    input[type="range"] {
      width: 90px;
    }
    
    input[type="text"] {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 13px;
      width: 150px;
    }
    
    select {
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 13px;
      background: white;
    }
    
    label {
      font-size: 12px;
      color: #555;
      font-weight: 500;
    }
    
    .canvas-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: auto;
      background: rgba(0,0,0,0.1);
    }
    
    .page-container {
      position: relative;
      width: 816px;  /* 21.59cm a 96dpi */
      height: 1056px; /* 27.94cm a 96dpi */
      background: white;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    /* Canvas de dibujo sobre la plantilla */
    #drawingCanvas {
      position: absolute;
      top: 0;
      left: 0;
      cursor: crosshair;
      z-index: 10;
    }
    
    /* Plantilla base (fondo) */
    .template-base {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .header-box {
      position: absolute;
      top: 20px;
      left: 57px;
      right: 57px;
      height: 45px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #ff5500;
      padding-bottom: 8px;
    }
    
    .header-box h2 {
      font-size: 16px;
      color: #333;
      font-weight: bold;
    }
    
    .header-box .logo {
      font-size: 14px;
      color: #ff5500;
      font-style: italic;
      font-weight: bold;
    }
    
    .work-area-bg {
      position: absolute;
      top: 75px;
      left: 57px;
      width: 702px;  /* 185.9mm */
      height: 903px; /* 239.4mm */
      background: #fff8f0;
    }
    
    .info-table {
      position: absolute;
      bottom: 20px;
      right: 57px;
      width: 300px;
      border: 2px solid #333;
      background: white;
      font-size: 11px;
    }
    
    .info-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .info-table td {
      border: 1px solid #666;
      padding: 6px;
    }
    
    .info-table td:first-child {
      font-weight: bold;
      width: 35%;
      background: #f0f0f0;
    }
    
    .watermark {
      position: absolute;
      bottom: 20px;
      left: 57px;
      font-size: 10px;
      color: #999;
      font-style: italic;
    }
    
    .status-bar {
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 20px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
      border-top: 1px solid #ddd;
    }
    
    .coords {
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }
    
    @media print {
      body {
        background: white;
      }
      
      .toolbar, .status-bar {
        display: none !important;
      }
      
      .canvas-wrapper {
        padding: 0;
        background: white;
      }
      
      .page-container {
        box-shadow: none;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Barra de herramientas -->
  <div class="toolbar">
    <h1>üìê Hoja Milim√©trica Oficial Interactiva</h1>
    <div class="tools">
      <div class="tool-group">
        <button id="pencil" class="active" title="L√°piz (P)">‚úèÔ∏è L√°piz</button>
        <button id="line" title="L√≠nea (L)">üìè L√≠nea</button>
        <button id="rect" title="Rect√°ngulo (R)">‚¨ú Rect</button>
        <button id="circle" title="C√≠rculo (C)">‚≠ï C√≠rculo</button>
        <button id="text" title="Texto (T)">üî§ Texto</button>
        <button id="eraser" title="Borrador (E)">üßπ Borrador</button>
      </div>
      
      <div class="tool-group">
        <label>Color:</label>
        <input type="color" id="color" value="#2c1810">
        <label>Grosor:</label>
        <input type="range" id="thickness" min="1" max="10" value="2">
        <span id="thicknessVal">2px</span>
      </div>
      
      <div class="tool-group">
        <label>Proyecto:</label>
        <select id="projectMode">
          <option value="free">Libre</option>
          <option value="math">Matem√°ticas</option>
          <option value="architecture">Arquitectura</option>
          <option value="electronics">Electr√≥nica</option>
          <option value="sewing">Costura</option>
        </select>
      </div>
      
      <div class="tool-group">
        <button id="undo" title="Deshacer (Ctrl+Z)">‚Ü∂ Deshacer</button>
        <button id="clear" title="Limpiar todo">üóëÔ∏è Limpiar</button>
        <button id="save" title="Guardar (Ctrl+S)">üíæ Guardar</button>
        <button id="print" title="Imprimir">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>
  
  <!-- √Årea de trabajo -->
  <div class="canvas-wrapper">
    <div class="page-container">
      <!-- Canvas de dibujo (transparente, encima) -->
      <canvas id="drawingCanvas" width="816" height="1056"></canvas>
      
      <!-- Plantilla base (debajo) -->
      <div class="template-base">
        <!-- Encabezado -->
        <div class="header-box">
          <h2>HOJA MILIM√âTRICA</h2>
          <div class="logo">Republica</div>
        </div>
        
        <!-- √Årea de trabajo con cuadr√≠cula -->
        <div class="work-area-bg">
          <svg width="702" height="903" viewBox="0 0 702 903" xmlns="http://www.w3.org/2000/svg" style="display: block;">
            <defs>
              <!-- 1mm - l√≠neas m√°s finas -->
              <pattern id="mm1" width="3.78" height="3.78" patternUnits="userSpaceOnUse">
                <path d="M 3.78 0 L 0 0 0 3.78" fill="none" stroke="#ffc299" stroke-width="0.3"/>
              </pattern>
              
              <!-- 5mm (0.5cm) -->
              <pattern id="mm5" width="18.9" height="18.9" patternUnits="userSpaceOnUse">
                <rect width="18.9" height="18.9" fill="url(#mm1)"/>
                <path d="M 18.9 0 L 0 0 0 18.9" fill="none" stroke="#ff9966" stroke-width="0.6"/>
              </pattern>
              
              <!-- 1cm -->
              <pattern id="cm1" width="37.8" height="37.8" patternUnits="userSpaceOnUse">
                <rect width="37.8" height="37.8" fill="url(#mm5)"/>
                <path d="M 37.8 0 L 0 0 0 37.8" fill="none" stroke="#ff7744" stroke-width="1"/>
              </pattern>
              
              <!-- 5cm (cuadros grandes) -->
              <pattern id="cm5" width="189" height="189" patternUnits="userSpaceOnUse">
                <rect width="189" height="189" fill="url(#cm1)"/>
                <path d="M 189 0 L 0 0 0 189" fill="none" stroke="#ff5500" stroke-width="2"/>
              </pattern>
            </defs>
            
            <!-- Aplicar cuadr√≠cula -->
            <rect width="702" height="903" fill="url(#cm5)"/>
            <rect x="0.5" y="0.5" width="701" height="902" fill="none" stroke="#ff5500" stroke-width="2.5"/>
          </svg>
        </div>
        
        <!-- Cuadro de informaci√≥n -->
        <div class="info-table">
          <table>
            <tr>
              <td>NOMBRE:</td>
              <td><input type="text" id="nombreInput" style="width: 100%; border: none; background: transparent;"></td>
            </tr>
            <tr>
              <td>MATERIA:</td>
              <td><input type="text" id="materiaInput" style="width: 100%; border: none; background: transparent;"></td>
            </tr>
            <tr>
              <td>FECHA:</td>
              <td><input type="text" id="fechaInput" style="width: 100%; border: none; background: transparent;"></td>
            </tr>
            <tr>
              <td>ESCALA:</td>
              <td>1:1</td>
            </tr>
            <tr>
              <td>GRADO:</td>
              <td><input type="text" id="gradoInput" style="width: 100%; border: none; background: transparent;"></td>
            </tr>
          </table>
        </div>
        
        <!-- Marca de agua -->
        <div class="watermark">
          Hoja Milim√©trica Oficial Mexicana - 21.59 √ó 27.94 cm
        </div>
      </div>
    </div>
  </div>
  
  <!-- Barra de estado -->
  <div class="status-bar">
    <div class="coords">Posici√≥n: <span id="coords">X: 0, Y: 0</span></div>
    <div>Herramienta: <span id="currentTool">L√°piz</span></div>
    <div>Modo: <span id="currentMode">Libre</span></div>
  </div>

  <script>
    // ==================== CONFIGURACI√ìN ====================
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    
    let state = {
      tool: 'pencil',
      color: '#2c1810',
      thickness: 2,
      isDrawing: false,
      startX: 0,
      startY: 0,
      history: [],
      historyStep: -1,
      projectMode: 'free'
    };
    
    // Canvas temporal para preview
    let tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    let tempCtx = tempCanvas.getContext('2d');
    
    // ==================== GUARDAR ESTADO ====================
    function saveState() {
      state.historyStep++;
      if (state.historyStep < state.history.length) {
        state.history.length = state.historyStep;
      }
      state.history.push(canvas.toDataURL());
    }
    
    function undo() {
      if (state.historyStep > 0) {
        state.historyStep--;
        const img = new Image();
        img.src = state.history[state.historyStep];
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
      }
    }
    
    // ==================== OBTENER POSICI√ìN ====================
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }
    
    // ==================== HERRAMIENTAS DE DIBUJO ====================
    function drawLine(x1, y1, x2, y2, color, thickness) {
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = color;
      ctx.lineWidth = thickness;
      ctx.lineCap = 'round';
      ctx.stroke();
    }
    
    function drawRect(x1, y1, x2, y2, color, thickness) {
      ctx.strokeStyle = color;
      ctx.lineWidth = thickness;
      ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
    }
    
    function drawCircle(x1, y1, x2, y2, color, thickness) {
      const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
      ctx.beginPath();
      ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = color;
      ctx.lineWidth = thickness;
      ctx.stroke();
    }
    
    function erase(x, y, size) {
      ctx.clearRect(x - size/2, y - size/2, size, size);
    }
    
    // ==================== EVENTOS DEL MOUSE ====================
    canvas.addEventListener('mousedown', (e) => {
      state.isDrawing = true;
      const pos = getMousePos(e);
      state.startX = pos.x;
      state.startY = pos.y;
      
      tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
      tempCtx.drawImage(canvas, 0, 0);
      
      if (state.tool === 'pencil') {
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      } else if (state.tool === 'eraser') {
        erase(pos.x, pos.y, state.thickness * 5);
      } else if (state.tool === 'text') {
        const text = prompt('Ingresa el texto:');
        if (text) {
          ctx.font = `${state.thickness * 6}px Arial`;
          ctx.fillStyle = state.color;
          ctx.fillText(text, pos.x, pos.y);
          saveState();
        }
        state.isDrawing = false;
      }
    });
    
    canvas.addEventListener('mousemove', (e) => {
      const pos = getMousePos(e);
      document.getElementById('coords').textContent = `X: ${Math.round(pos.x)}px, Y: ${Math.round(pos.y)}px`;
      
      if (!state.isDrawing) return;
      
      if (state.tool === 'pencil') {
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = state.color;
        ctx.lineWidth = state.thickness;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
      } else if (state.tool === 'eraser') {
        erase(pos.x, pos.y, state.thickness * 5);
      } else {
        // Preview
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(tempCanvas, 0, 0);
        
        if (state.tool === 'line') {
          drawLine(state.startX, state.startY, pos.x, pos.y, state.color, state.thickness);
        } else if (state.tool === 'rect') {
          drawRect(state.startX, state.startY, pos.x, pos.y, state.color, state.thickness);
        } else if (state.tool === 'circle') {
          drawCircle(state.startX, state.startY, pos.x, pos.y, state.color, state.thickness);
        }
      }
    });
    
    canvas.addEventListener('mouseup', (e) => {
      if (!state.isDrawing) return;
      
      const pos = getMousePos(e);
      
      if (state.tool === 'line') {
        drawLine(state.startX, state.startY, pos.x, pos.y, state.color, state.thickness);
      } else if (state.tool === 'rect') {
        drawRect(state.startX, state.startY, pos.x, pos.y, state.color, state.thickness);
      } else if (state.tool === 'circle') {
        drawCircle(state.startX, state.startY, pos.x, pos.y, state.color, state.thickness);
      }
      
      state.isDrawing = false;
      saveState();
    });
    
    canvas.addEventListener('mouseleave', () => {
      state.isDrawing = false;
    });
    
    // ==================== BOTONES ====================
    function setTool(tool, name) {
      state.tool = tool;
      document.querySelectorAll('.tool-group button').forEach(b => b.classList.remove('active'));
      document.getElementById(tool).classList.add('active');
      document.getElementById('currentTool').textContent = name;
    }
    
    document.getElementById('pencil').onclick = () => setTool('pencil', 'L√°piz');
    document.getElementById('line').onclick = () => setTool('line', 'L√≠nea');
    document.getElementById('rect').onclick = () => setTool('rect', 'Rect√°ngulo');
    document.getElementById('circle').onclick = () => setTool('circle', 'C√≠rculo');
    document.getElementById('text').onclick = () => setTool('text', 'Texto');
    document.getElementById('eraser').onclick = () => setTool('eraser', 'Borrador');
    
    document.getElementById('color').oninput = (e) => state.color = e.target.value;
    document.getElementById('thickness').oninput = (e) => {
      state.thickness = e.target.value;
      document.getElementById('thicknessVal').textContent = e.target.value + 'px';
    };
    
    document.getElementById('projectMode').onchange = (e) => {
      state.projectMode = e.target.value;
      document.getElementById('currentMode').textContent = e.target.options[e.target.selectedIndex].text;
    };
    
    document.getElementById('undo').onclick = undo;
    
    document.getElementById('clear').onclick = () => {
      if (confirm('¬øLimpiar todo el dibujo?')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        saveState();
      }
    };
    
    document.getElementById('save').onclick = () => {
      // Crear canvas combinado
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = 816;
      finalCanvas.height = 1056;
      const finalCtx = finalCanvas.getContext('2d');
      
      // Capturar la plantilla base
      const container = document.querySelector('.page-container');
      
      // Dibujar fondo blanco
      finalCtx.fillStyle = 'white';
      finalCtx.fillRect(0, 0, 816, 1056);
      
      // Renderizar SVG y elementos HTML como imagen
      const svg = container.querySelector('svg');
      const svgData = new XMLSerializer().serializeToString(svg);
      const img = new Image();
      const blob = new Blob([svgData], {type: 'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      
      img.onload = () => {
        // Dibujar √°rea de trabajo
        finalCtx.fillStyle = '#fff8f0';
        finalCtx.fillRect(57, 75, 702, 903);
        
        // Dibujar cuadr√≠cula
        finalCtx.drawImage(img, 57, 75, 702, 903);
        
        // Dibujar el canvas de dibujo
        finalCtx.drawImage(canvas, 0, 0);
        
        // Descargar
        const link = document.createElement('a');
        link.download = `hoja_milimetrica_${Date.now()}.png`;
        link.href = finalCanvas.toDataURL();
        link.click();
        
        URL.revokeObjectURL(url);
      };
      img.src = url;
    };
    
    document.getElementById('print').onclick = () => window.print();
    
    // ==================== ATAJOS DE TECLADO ====================
    document.addEventListener('keydown', (e) => {
      if (e.key === 'p') setTool('pencil', 'L√°piz');
      if (e.key === 'l') setTool('line', 'L√≠nea');
      if (e.key === 'r') setTool('rect', 'Rect√°ngulo');
      if (e.key === 'c') setTool('circle', 'C√≠rculo');
      if (e.key === 't') setTool('text', 'Texto');
      if (e.key === 'e') setTool('eraser', 'Borrador');
      if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
      if (e.ctrlKey && e.key === 's') { e.preventDefault(); document.getElementById('save').click(); }
    });
    
    // Auto-completar fecha
    document.getElementById('fechaInput').value = new Date().toLocaleDateString('es-MX');
    
    // Inicializar
    saveState();
  </script>
</body>
</html>