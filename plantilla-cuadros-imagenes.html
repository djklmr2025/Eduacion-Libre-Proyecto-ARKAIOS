<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plantilla de Impresi√≥n de Im√°genes | ARKAIOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .panel-control {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .header h1 {
      color: #667eea;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .controles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .control-group select,
    .control-group input[type="number"] {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      background: white;
    }

    .control-group select:focus,
    .control-group input[type="number"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .botones-accion {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #48bb78;
      color: white;
    }

    .btn-secondary:hover {
      background: #38a169;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
      transform: translateY(-2px);
    }

    .stats {
      display: flex;
      gap: 20px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 8px;
      margin-top: 16px;
    }

    .stat-item {
      flex: 1;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .hojas-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .page-wrapper {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .page-info {
      text-align: center;
      margin-bottom: 16px;
      font-weight: 600;
      color: #667eea;
      font-size: 14px;
    }

    .page-container {
      width: 21.59cm;
      height: 27.94cm;
      background: white;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cuadricula {
      display: grid;
      gap: 0;
    }

    .celda-imagen {
      border: 1px dashed #cbd5e0;
      background: #fafafa;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .celda-imagen:hover {
      border-color: #667eea;
      background: #f7fafc;
    }

    .celda-imagen.dragging {
      opacity: 0.5;
      border: 2px solid #667eea;
    }

    .celda-imagen.drag-over {
      background: #e6f2ff;
      border: 2px solid #667eea;
    }

    .num-celda {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(102, 126, 234, 0.9);
      color: white;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      z-index: 2;
    }

    .img-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .img-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.3s;
      user-select: none;
    }

    .img-preview.moviendo {
      cursor: move;
    }

    .botones-celda {
      position: absolute;
      bottom: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 3;
    }

    .celda-imagen:hover .botones-celda {
      opacity: 1;
    }

    .btn-celda {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .btn-editar {
      background: #48bb78;
    }

    .btn-editar:hover {
      background: #38a169;
    }

    .btn-fijar {
      background: #4299e1;
    }

    .btn-fijar:hover {
      background: #3182ce;
    }

    .btn-eliminar {
      background: #f56565;
    }

    .btn-eliminar:hover {
      background: #e53e3e;
    }

    .celda-vacia {
      color: #cbd5e0;
      font-size: 32px;
      font-weight: 300;
    }

    #pixabay-credit {
      margin: 12px auto;
      background: #f8fafc;
      border: 1px solid #d1d5db;
      padding: 10px 14px;
      border-radius: 10px;
      color: #1f2937;
      font-weight: 600;
      max-width: 960px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    }

    .modal-editor {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-editor.activo {
      display: flex;
    }

    .modal-contenido {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      color: #667eea;
      font-size: 20px;
    }

    .btn-cerrar {
      background: #f56565;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .editor-preview {
      width: 100%;
      max-height: 400px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fafafa;
    }

    .editor-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .controles-editor {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .control-zoom {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .control-zoom input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #e0e0e0;
      outline: none;
    }

    .control-zoom input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }

    .zoom-valor {
      font-weight: 600;
      margin: 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="panel-control">
      </button>
      <button class="btn btn-secondary" onclick="window.print()">
        üñ®Ô∏è Imprimir hojas
      </button>
      <button class="btn btn-danger" onclick="limpiarTodo()">
        üóëÔ∏è Limpiar todo
      </button>
    </div>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-imagenes">0</div>
        <div class="stat-label">Im√°genes</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-hojas">0</div>
        <div class="stat-label">Hojas</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-cuadros">0</div>
        <div class="stat-label">Cuadros/Hoja</div>
      </div>
    </div>
  </div>

  <div id="hojas-container" class="hojas-container"></div>
  </div>

  <div id="modal-editor" class="modal-editor">
    <div class="modal-contenido">
      <div class="modal-header">
        <h3>‚úèÔ∏è Editar Imagen</h3>
        <button class="btn-cerrar" onclick="cerrarEditor()">‚úï Cerrar</button>
      </div>
      <div class="editor-preview" id="editor-preview">
        <img id="editor-img" src="" alt="">
      </div>
      <div class="controles-editor">
        <div class="control-zoom">
          <label>üîç Zoom:</label>
          <input type="range" id="zoom-slider" min="100" max="200" value="100" step="1">
          <span class="zoom-valor" id="zoom-valor">100%</span>
        </div>
        <button class="btn btn-primary" onclick="aplicarEdicion()">‚úì Aplicar cambios</button>
      </div>
    </div>

    archivos.forEach(archivo => {
    const reader = new FileReader();
    reader.onload = function (ev) {
    imagenes.push(ev.target.result);
    estadosImagen.push({ zoom: 100, x: 0, y: 0, fijada: false });
    cargados++;
    if (cargados === archivos.length) {
    generarPlantilla();
    }
    };
    reader.readAsDataURL(archivo);
    });

    e.target.value = '';
    });

    inputIndividual.addEventListener('change', function (e) {
    const archivo = e.target.files[0];
    if (!archivo) return;

    const reader = new FileReader();
    reader.onload = function (ev) {
    if (indiceEditando >= 0) {
    imagenes[indiceEditando] = ev.target.result;
    estadosImagen[indiceEditando] = { zoom: 100, x: 0, y: 0, fijada: false };
    generarPlantilla();
    }
    };
    reader.readAsDataURL(archivo);

    e.target.value = '';
    });

    function generarPlantilla() {
    hojasContainer.innerHTML = '';

    const tamano = parseInt(selectorTamano.value);
    const filas = Math.floor(27.94 / tamano);
    const cols = Math.floor(21.59 / tamano);
    const cuadrosPorHoja = filas * cols;
    const hojasNecesarias = Math.max(1, Math.ceil(imagenes.length / cuadrosPorHoja));

    actualizarEstadisticas(imagenes.length, hojasNecesarias, cuadrosPorHoja);

    for (let h = 0; h < hojasNecesarias; h++) { const pageWrapper=document.createElement('div');
      pageWrapper.className='page-wrapper' ; const pageInfo=document.createElement('div');
      pageInfo.className='page-info' ; pageInfo.textContent=`Hoja ${h + 1} de ${hojasNecesarias}`;
      pageWrapper.appendChild(pageInfo); const pageContainer=document.createElement('div');
      pageContainer.className='page-container' ; const cuadricula=document.createElement('div');
      cuadricula.className='cuadricula' ; cuadricula.style.gridTemplateColumns=`repeat(${cols}, ${tamano}cm)`;
      cuadricula.style.gridTemplateRows=`repeat(${filas}, ${tamano}cm)`; const inicio=h * cuadrosPorHoja; const
      fin=Math.min(inicio + cuadrosPorHoja, imagenes.length); for (let i=0; i < cuadrosPorHoja; i++) { const idx=inicio
      + i; const celda=crearCelda(idx, tamano); cuadricula.appendChild(celda); } pageContainer.appendChild(cuadricula);
      pageWrapper.appendChild(pageContainer); hojasContainer.appendChild(pageWrapper); } } function crearCelda(idx,
      tamano) { const celda=document.createElement('div'); celda.className='celda-imagen arkaios-image-slot' ;
      celda.style.width=`${tamano}cm`; celda.style.height=`${tamano}cm`; celda.draggable=imagenes[idx] ? true : false;
      celda.dataset.idx=idx; const numCelda=document.createElement('span'); numCelda.className='num-celda' ;
      numCelda.textContent=idx + 1; celda.appendChild(numCelda); if (imagenes[idx]) { const
      imgContainer=document.createElement('div'); imgContainer.className='img-container' ; const
      img=document.createElement('img'); img.src=imagenes[idx]; img.className='img-preview' ; const
      estado=estadosImagen[idx] || { zoom: 100, x: 0, y: 0, fijada: false }; img.style.transform=`scale(${estado.zoom /
      100})`; imgContainer.appendChild(img); celda.appendChild(imgContainer); const
      botones=document.createElement('div'); botones.className='botones-celda' ; const
      btnEditar=document.createElement('button'); btnEditar.className='btn-celda btn-editar' ;
      btnEditar.textContent='‚úèÔ∏è' ; btnEditar.onclick=(e)=> {
      e.stopPropagation();
      abrirEditor(idx);
      };

      const btnFijar = document.createElement('button');
      btnFijar.className = 'btn-celda btn-fijar';
      btnFijar.textContent = estado.fijada ? 'üîì' : 'üìå';
      btnFijar.onclick = (e) => {
      e.stopPropagation();
      toggleFijar(idx);
      };

      const btnEliminar = document.createElement('button');
      btnEliminar.className = 'btn-celda btn-eliminar';
      btnEliminar.textContent = 'üóëÔ∏è';
      btnEliminar.onclick = (e) => {
      e.stopPropagation();
      eliminarImagen(idx);
      };

      botones.appendChild(btnEditar);
      botones.appendChild(btnFijar);
      botones.appendChild(btnEliminar);
      celda.appendChild(botones);

      celda.addEventListener('dragstart', handleDragStart);
      celda.addEventListener('dragover', handleDragOver);
      celda.addEventListener('drop', handleDrop);
      celda.addEventListener('dragend', handleDragEnd);
      } else {
      const icono = document.createElement('span');
      icono.className = 'celda-vacia';
      icono.textContent = '+';
      celda.appendChild(icono);

      celda.onclick = function () {
      indiceEditando = idx;
      inputIndividual.click();
      };
      }

      return celda;
      }

      function handleDragStart(e) {
      const idx = parseInt(e.currentTarget.dataset.idx);
      if (estadosImagen[idx]?.fijada) {
      e.preventDefault();
      return;
      }
      indiceDragInicio = idx;
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      }

      function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
      e.dataTransfer.dropEffect = 'move';
      }

      function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      const idxDestino = parseInt(e.currentTarget.dataset.idx);

      if (indiceDragInicio !== -1 && indiceDragInicio !== idxDestino) {
      const temp = imagenes[indiceDragInicio];
      const tempEstado = estadosImagen[indiceDragInicio];

      imagenes[indiceDragInicio] = imagenes[idxDestino];
      estadosImagen[indiceDragInicio] = estadosImagen[idxDestino];

      imagenes[idxDestino] = temp;
      estadosImagen[idxDestino] = tempEstado;

      generarPlantilla();
      }
      }

      function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => {
      el.classList.remove('drag-over');
      });
      indiceDragInicio = -1;
      }

      function abrirEditor(idx) {
      indiceEditando = idx;
      editorImg.src = imagenes[idx];
      const estado = estadosImagen[idx] || { zoom: 100 };
      zoomSlider.value = estado.zoom;
      zoomValor.textContent = estado.zoom + '%';
      editorImg.style.transform = `scale(${estado.zoom / 100})`;
      modalEditor.classList.add('activo');
      }

      function cerrarEditor() {
      modalEditor.classList.remove('activo');
      indiceEditando = -1;
      }

      zoomSlider.addEventListener('input', function () {
      const zoom = parseInt(this.value);
      zoomValor.textContent = zoom + '%';
      editorImg.style.transform = `scale(${zoom / 100})`;
      });

      function aplicarEdicion() {
      if (indiceEditando >= 0) {
      estadosImagen[indiceEditando].zoom = parseInt(zoomSlider.value);
      generarPlantilla();
      cerrarEditor();
      }
      }

      function toggleFijar(idx) {
      if (!estadosImagen[idx]) {
      estadosImagen[idx] = { zoom: 100, x: 0, y: 0, fijada: false };
      }
      estadosImagen[idx].fijada = !estadosImagen[idx].fijada;
      generarPlantilla();
      }

      function eliminarImagen(idx) {
      if (confirm('¬øEliminar esta imagen?')) {
      imagenes.splice(idx, 1);
      estadosImagen.splice(idx, 1);
      generarPlantilla();
      }
      }

      function limpiarTodo() {
      if (confirm('¬øEliminar todas las im√°genes?')) {
      imagenes = [];
      estadosImagen = [];
      generarPlantilla();
      }
      }

      function actualizarEstadisticas(numImagenes, numHojas, cuadrosPorHoja) {
      document.getElementById('stat-imagenes').textContent = numImagenes;
      document.getElementById('stat-hojas').textContent = numHojas;
      document.getElementById('stat-cuadros').textContent = cuadrosPorHoja;
      }

      function mostrarCreditoPixabay(topic, count) {
      let credit = document.getElementById('pixabay-credit');
      if (!credit) {
      credit = document.createElement('div');
      credit.id = 'pixabay-credit';
      const container = document.querySelector('.container');
      container?.insertBefore(credit, container.firstChild);
      }
      const cleanTopic = topic || 'Pixabay';
      credit.textContent = `Im√°genes de Pixabay (${count}) ¬∑ Tema: ${cleanTopic}`;
      }

      function rellenarConPixabay(urls = [], topic = 'Pixabay') {
      if (!Array.isArray(urls) || urls.length === 0) return;
      imagenes = urls.slice();
      estadosImagen = imagenes.map(() => ({ zoom: 100, x: 0, y: 0, fijada: false }));
      generarPlantilla();
      mostrarCreditoPixabay(topic, urls.length);
      }

      window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || data.type !== 'ARKAIOS_PIXABAY_IMAGES') return;
      rellenarConPixabay(data.images || [], data.topic || 'Pixabay');
      });

      generarPlantilla();
      </script>
</body>

</html>