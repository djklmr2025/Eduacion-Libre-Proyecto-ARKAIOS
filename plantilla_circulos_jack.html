<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plantilla C√≠rculos Jack Skellington | ARKAIOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f4f6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 40px;
    }

    .no-print-bar {
      width: 100%;
      background: #1f2937;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .no-print-bar h1 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #60a5fa;
    }

    .no-print-bar .info {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(110%);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .pages-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
      margin-top: 30px;
      width: 100%;
      align-items: center;
    }

    .page-wrapper {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      width: 21.59cm;
    }

    .page-header h2 {
      font-size: 1rem;
      color: #374151;
    }

    .page {
      width: 21.59cm;
      height: 27.94cm;
      background: white;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .page-inner {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .circle {
      position: absolute;
      border-radius: 50%;
      border: 2px dashed #d1d5db;
      background: #f9fafb;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .circle:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .circle.has-image {
      border: none;
      background: transparent;
    }

    .circle.locked {
      border: 2px solid #10b981;
    }

    .circle-grande {
      width: 12cm;
      height: 12cm;
    }

    .circle-pequeno {
      width: 5cm;
      height: 5cm;
    }

    .circle-label {
      text-align: center;
      color: #9ca3af;
      font-size: 0.8rem;
      pointer-events: none;
    }

    .circle-image-wrapper {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
      border-radius: 50%;
    }

    .circle-image-wrapper img {
      position: absolute;
      object-fit: cover;
      user-select: none;
      /* Importante para el drag custom */
    }

    .circle-image-wrapper img.dragging {
      cursor: grabbing;
      opacity: 0.8;
    }

    .page-note {
      position: absolute;
      bottom: 10px;
      right: 20px;
      font-size: 10px;
      color: #9ca3af;
    }

    #pixabay-credit {
      margin: 12px auto;
      background: white;
      border: 1px solid #d1d5db;
      padding: 10px 14px;
      border-radius: 10px;
      color: #1f2937;
      font-weight: 600;
      max-width: 960px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Controles superpuestos en el c√≠rculo */
    .circle-controls {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 20;
    }

    .circle:hover .circle-controls {
      opacity: 1;
    }

    .chip {
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 10px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .chip:hover {
      background: rgba(59, 130, 246, 0.9);
      transform: scale(1.05);
    }

    .chip-danger {
      background: rgba(185, 28, 28, 0.9);
      border-color: rgba(248, 113, 113, 0.7);
    }

    .chip-danger:hover {
      background: rgba(220, 38, 38, 0.9);
    }

    /* Badge de fijado */
    .locked-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 9px;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
    }

    /* Panel de edici√≥n flotante */
    .edit-panel {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      width: 320px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 3px solid #3b82f6;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      display: none;
      z-index: 1000;
    }

    .edit-panel.active {
      display: block;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50%) translateX(20px);
        opacity: 0;
      }

      to {
        transform: translateY(-50%) translateX(0);
        opacity: 1;
      }
    }

    .edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #3b82f6;
    }

    .edit-header h3 {
      font-size: 1.1rem;
      color: #3b82f6;
      font-weight: 700;
    }

    .edit-close {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      color: #ef4444;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .edit-close:hover {
      background: #ef4444;
      color: white;
      transform: rotate(90deg);
    }

    .edit-control {
      margin-bottom: 16px;
    }

    .edit-control label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
    }

    .edit-control .value {
      color: #3b82f6;
      font-weight: bold;
    }

    .edit-control input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #1f2937;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .edit-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
    }

    .edit-control input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      cursor: pointer;
      border: none;
    }

    .edit-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid #3b82f6;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #93c5fd;
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .edit-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 20px;
    }

    .edit-btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-btn-lock {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .edit-btn-lock:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
    }

    .edit-btn-unlock {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .edit-btn-delete {
      background: #1f2937;
      color: #ef4444;
      border: 2px solid #ef4444;
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }

      .no-print-bar,
      .edit-panel,
      .page-header,
      #pixabay-credit,
      .no-print,
      #aiModal {
        display: none !important;
      }

      .pages-container {
        gap: 0;
        padding: 0;
      }

      .page-wrapper {
        max-width: none;
      }

      .page {
        box-shadow: none;
        margin: 0;
        border-radius: 0;
        page-break-after: always;
      }

      .page:last-child {
        page-break-after: auto;
      }

      .circle-controls,
      .locked-badge {
        display: none !important;
      }
    }

    @page {
      size: 21.59cm 27.94cm;
      margin: 0;
    }

    @media (max-width: 768px) {
      .edit-panel {
        position: fixed;
        top: auto;
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        transform: none;
        border-radius: 16px 16px 0 0;
      }

      .edit-panel.active {
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }

        to {
          transform: translateY(0);
        }
      }
    }
  </style>
</head>

<body>
  <div class="no-print-bar">
    <div>
      <!-- Panel de edici√≥n flotante -->
      <div class="edit-panel" id="editPanel">
        <div class="edit-header">
          <h3>‚úèÔ∏è Editor de C√≠rculo</h3>
          <button class="edit-close" id="editClose">√ó</button>
        </div>

        <div class="edit-info">
          üí° <strong>Tip:</strong> Arrastra la imagen con el mouse para moverla libremente dentro del c√≠rculo
        </div>

        <div class="edit-control">
          <label>Tama√±o: <span class="value" id="scaleValue">100%</span></label>
          <input type="range" id="scaleSlider" min="50" max="200" value="100">
        </div>

        <div class="edit-buttons">
          <button class="edit-btn edit-btn-lock" id="btnLock">üîí Fijar Imagen</button>
          <button class="edit-btn edit-btn-delete" id="btnDeleteImage">üóëÔ∏è Eliminar Imagen</button>
        </div>
      </div>
      <h1>Plantilla Educativa - C√≠rculos Jack Skellington (Completa)</h1>
      <div class="info">Sube im√°genes, edita y genera el PDF para imprimir.</div>
    </div>
    <div class="actions">
      <button class="btn-primary" id="btnAddPage">‚ûï Agregar Hoja</button>
      <button class="btn-success" onclick="window.print()">üñ®Ô∏è Imprimir PDF</button>
      <button class="btn-danger" id="btnClearAll">üóëÔ∏è Limpiar Todo</button>
      <button class="btn-warning" id="btnBulkLarge">üìÇ Cargar Lote (Grandes)</button>
      <button class="btn-warning" id="btnBulkSmall">üìÇ Cargar Lote (Peque√±os)</button>
      <button class="btn-primary" onclick="searchPexels()">üì∏ Pexels</button>
      <button class="btn-primary" onclick="searchFreepik()">üé® Freepik</button>
      <button class="btn-primary" onclick="openAIModal()">‚ú® Crear con IA</button>
    </div>
  </div>

  }

  function clearAll() {
  if (!confirm('¬øLimpiar todas las hojas e im√°genes?')) return;
  pages = [];
  addPage();
  closeEditPanel();
  }

  // ===== RENDERIZAR =====
  const CIRCULO_GRANDE = 12 * 37.795; // 12cm en p√≠xeles
  const CIRCULO_PEQUENO = 5 * 37.795; // 5cm en p√≠xeles

  function renderPages() {
  pagesContainer.innerHTML = '';
  pages.forEach((page, index) => {
  const wrapper = document.createElement('div');
  wrapper.className = 'page-wrapper';

  const header = document.createElement('div');
  header.className = 'page-header';

  const title = document.createElement('h2');
  title.textContent = `üìÑ Hoja ${index + 1}`;

  const btnDelete = document.createElement('button');
  btnDelete.className = 'btn-danger';
  btnDelete.textContent = 'üóëÔ∏è Eliminar Hoja';
  btnDelete.style.fontSize = '0.85rem';
  btnDelete.style.padding = '6px 12px';
  btnDelete.onclick = () => removePage(page.id);
  if (pages.length <= 1) { btnDelete.disabled=true; btnDelete.style.opacity='0.5' ; btnDelete.style.cursor='not-allowed'
    ; } header.appendChild(title); header.appendChild(btnDelete); const pageEl=document.createElement('div');
    pageEl.className='page' ; const inner=document.createElement('div'); inner.className='page-inner' ; // Posiciones
    fijas para los c√≠rculos // Grande: 12cm, Peque√±o: 5cm // Hoja carta: 21.59cm x 27.94cm // M√°rgenes internos: 1.5cm
    const positions={ grande: [ { left: '1.2cm' , top: '2cm' }, { left: '1.2cm' , bottom: '2cm' } ], pequeno: [ {
    right: '1.8cm' , top: '2cm' }, { right: '1.8cm' , top: '8cm' }, { right: '1.8cm' , top: '14cm' }, { right: '1.8cm' ,
    top: '20cm' } ] }; let gIndex=0; let pIndex=0; page.circles.forEach(circle=> {
    const circleDiv = document.createElement('div');
    circleDiv.className = 'circle ' + (circle.size === 'grande' ? 'circle-grande' : 'circle-pequeno') + '
    arkaios-image-slot';
    if (circle.locked) circleDiv.classList.add('locked');

    const pos = circle.size === 'grande'
    ? positions.grande[gIndex++]
    : positions.pequeno[pIndex++];

    Object.assign(circleDiv.style, pos);

    circleDiv.onclick = () => handleCircleClick(page.id, circle.id);

    if (circle.imageData) {
    circleDiv.classList.add('has-image');

    const imgWrapper = document.createElement('div');
    imgWrapper.className = 'circle-image-wrapper';

    const img = document.createElement('img');
    img.src = circle.imageData;
    img.alt = 'Imagen c√≠rculo';

    // Aplicar transformaciones
    const scale = circle.scale / 100;
    // Calcular tama√±o visual
    const size = Math.max(circle.size === 'grande' ? 12 : 5, (circle.size === 'grande' ? 12 : 5) * scale);

    img.style.width = size + 'cm';
    img.style.height = size + 'cm';
    img.style.left = circle.posX + '%';
    img.style.top = circle.posY + '%';
    img.style.transform = 'translate(-50%, -50%)';

    // Setup drag si no est√° bloqueada
    if (!circle.locked) {
    setupImageDrag(img, page.id, circle.id);
    }

    imgWrapper.appendChild(img);
    circleDiv.appendChild(imgWrapper);

    if (circle.locked) {
    const badge = document.createElement('div');
    badge.className = 'locked-badge';
    badge.textContent = 'FIJADA ‚úì';
    circleDiv.appendChild(badge);
    }

    if (!circle.locked) {
    const controls = document.createElement('div');
    controls.className = 'circle-controls';

    const chipEdit = document.createElement('div');
    chipEdit.className = 'chip';
    chipEdit.textContent = '‚úèÔ∏è Editar';
    chipEdit.onclick = (ev) => {
    ev.stopPropagation();
    openEditPanel(page.id, circle.id);
    };

    const chipChange = document.createElement('div');
    chipChange.className = 'chip';
    chipChange.textContent = 'üì∑ Cambiar';
    chipChange.onclick = (ev) => {
    ev.stopPropagation();
    changeImage(page.id, circle.id);
    };

    const chipRemove = document.createElement('div');
    chipRemove.className = 'chip chip-danger';
    chipRemove.textContent = '‚úï';
    chipRemove.onclick = (ev) => {
    ev.stopPropagation();
    removeImage(page.id, circle.id);
    };

    controls.appendChild(chipEdit);
    controls.appendChild(chipChange);
    controls.appendChild(chipRemove);
    circleDiv.appendChild(controls);
    }
    } else {
    const label = document.createElement('div');
    label.className = 'circle-label';
    label.innerHTML = circle.size === 'grande'
    ? 'üì∑<br>Clic para subir imagen<br><strong>12 cm</strong>'
    : 'üì∑<br>Clic para subir imagen<br><strong>5 cm</strong>';
    circleDiv.appendChild(label);
    }

    inner.appendChild(circleDiv);
    });

    const note = document.createElement('div');
    note.className = 'page-note';
    note.textContent = `P√°gina ${index + 1}`;

    inner.appendChild(note);
    pageEl.appendChild(inner);

    wrapper.appendChild(header);
    wrapper.appendChild(pageEl);
    pagesContainer.appendChild(wrapper);
    });
    }

    btnAddPage.addEventListener('click', addPage);
    btnClearAll.addEventListener('click', clearAll);

    // Iniciar con una hoja
    addPage();

    // Cerrar panel al hacer clic fuera
    document.addEventListener('click', (e) => {
    if (editPanel.classList.contains('active') &&
    !editPanel.contains(e.target) &&
    !e.target.closest('.circle')) {
    closeEditPanel();
    }
    });

    // ===== CARGA EN LOTE =====
    btnBulkLarge.addEventListener('click', () => fileInputBulkLarge.click());
    btnBulkSmall.addEventListener('click', () => fileInputBulkSmall.click());

    fileInputBulkLarge.addEventListener('change', (e) => {
    handleBulkUpload(e.target.files, 'grande');
    });

    fileInputBulkSmall.addEventListener('change', (e) => {
    handleBulkUpload(e.target.files, 'pequeno');
    });

    function handleBulkUpload(files, size) {
    if (!files || files.length === 0) return;

    const filesArray = Array.from(files);
    const circlesPerPage = size === 'grande' ? 2 : 4;
    const pagesNeeded = Math.ceil(filesArray.length / circlesPerPage);

    // Asegurar que tengamos suficientes p√°ginas
    while (pages.length < pagesNeeded) { addPage(); } // Cargar cada imagen filesArray.forEach((file, index)=> {
      const reader = new FileReader();
      reader.onload = (ev) => {
      const dataUrl = ev.target.result;
      const pageIndex = Math.floor(index / circlesPerPage);
      const circleIndex = index % circlesPerPage;

      if (pages[pageIndex]) {
      const circles = pages[pageIndex].circles;
      const targetCircle = size === 'grande'
      ? circles.filter(c => c.size === 'grande')[circleIndex]
      : circles.filter(c => c.size === 'pequeno')[circleIndex];

      if (targetCircle) {
      targetCircle.imageData = dataUrl;
      targetCircle.scale = 100;
      targetCircle.posX = 50;
      targetCircle.posY = 50;
      targetCircle.locked = false;
      }
      }

      // Renderizar cuando se complete la √∫ltima imagen
      if (index === filesArray.length - 1) {
      renderPages();
      }
      };
      reader.readAsDataURL(file);
      });
      }

      // ===== CARGA INDIVIDUAL =====
      function handleCircleClick(pageId, circleId) {
      const circle = findCircle(pageId, circleId);
      if (circle && circle.imageData && !circle.locked) {
      openEditPanel(pageId, circleId);
      } else if (!circle.imageData) {
      circleToFill = { pageId, circleId };
      fileInputHidden.value = '';
      fileInputHidden.click();
      }
      }

      fileInputHidden.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || !circleToFill) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
      const dataUrl = ev.target.result;
      pages = pages.map(page => {
      if (page.id === circleToFill.pageId) {
      return {
      ...page,
      circles: page.circles.map(c =>
      c.id === circleToFill.circleId
      ? { ...c, imageData: dataUrl, scale: 100, posX: 50, posY: 50, locked: false }
      : c
      )
      };
      }
      return page;
      });
      circleToFill = null;
      renderPages();
      };
      reader.readAsDataURL(file);
      });

      // ===== FUNCIONES DE EDICI√ìN =====
      function findCircle(pageId, circleId) {
      const page = pages.find(p => p.id === pageId);
      return page ? page.circles.find(c => c.id === circleId) : null;
      }

      function updateCircle(pageId, circleId, updates) {
      pages = pages.map(page => {
      if (page.id === pageId) {
      return {
      ...page,
      circles: page.circles.map(c =>
      c.id === circleId ? { ...c, ...updates } : c
      )
      };
      }
      return page;
      });
      renderPages();
      }

      function openEditPanel(pageId, circleId) {
      const circle = findCircle(pageId, circleId);
      if (!circle || !circle.imageData) return;

      editingCircle = { pageId, circleId };
      scaleSlider.value = circle.scale;
      updateSliderValues();

      scaleSlider.disabled = circle.locked;

      btnLock.textContent = circle.locked ? 'üîì Desbloquear' : 'üîí Fijar Imagen';
      btnLock.className = circle.locked ? 'edit-btn edit-btn-unlock' : 'edit-btn edit-btn-lock';

      editPanel.classList.add('active');
      }

      function closeEditPanel() {
      editPanel.classList.remove('active');
      editingCircle = null;
      }

      function updateSliderValues() {
      scaleValue.textContent = scaleSlider.value + '%';
      }

      scaleSlider.addEventListener('input', () => {
      if (!editingCircle) return;
      updateSliderValues();
      updateCircle(editingCircle.pageId, editingCircle.circleId, {
      scale: parseInt(scaleSlider.value)
      });
      });

      btnLock.addEventListener('click', () => {
      if (!editingCircle) return;
      const circle = findCircle(editingCircle.pageId, editingCircle.circleId);
      updateCircle(editingCircle.pageId, editingCircle.circleId, {
      locked: !circle.locked
      });
      if (!circle.locked) {
      closeEditPanel();
      } else {
      openEditPanel(editingCircle.pageId, editingCircle.circleId);
      }
      });

      btnDeleteImage.addEventListener('click', () => {
      if (!editingCircle) return;
      if (confirm('¬øEliminar esta imagen?')) {
      updateCircle(editingCircle.pageId, editingCircle.circleId, {
      imageData: null,
      scale: 100,
      posX: 50,
      posY: 50,
      locked: false
      });
      closeEditPanel();
      }
      });

      // ===== ARRASTRAR IMAGEN =====
      function setupImageDrag(img, pageId, circleId) {
      img.addEventListener('mousedown', (e) => {
      e.preventDefault();
      draggedImage = { img, pageId, circleId };
      dragStartX = e.clientX;
      dragStartY = e.clientY;

      img.classList.add('dragging');

      // Obtener posici√≥n actual
      const currentLeft = parseFloat(img.style.left) || 50;
      const currentTop = parseFloat(img.style.top) || 50;
      imageStartX = currentLeft;
      imageStartY = currentTop;
      });
      }

      document.addEventListener('mousemove', (e) => {
      if (!draggedImage) return;
      e.preventDefault();

      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;

      // Convertir p√≠xeles a porcentaje (aproximado)
      const circle = findCircle(draggedImage.pageId, draggedImage.circleId);
      const circleSize = circle.size === 'grande' ? CIRCULO_GRANDE : CIRCULO_PEQUENO;
      const percentX = (deltaX / circleSize) * 100;
      const percentY = (deltaY / circleSize) * 100;

      const newX = Math.max(0, Math.min(100, imageStartX + percentX));
      const newY = Math.max(0, Math.min(100, imageStartY + percentY));

      draggedImage.img.style.left = newX + '%';
      draggedImage.img.style.top = newY + '%';
      });

      document.addEventListener('mouseup', () => {
      if (!draggedImage) return;

      const img = draggedImage.img;
      const pageId = draggedImage.pageId;
      const circleId = draggedImage.circleId;

      img.classList.remove('dragging');

      const finalX = parseFloat(img.style.left) || 50;
      const finalY = parseFloat(img.style.top) || 50;

      updateCircle(pageId, circleId, {
      posX: finalX,
      posY: finalY
      });

      draggedImage = null;
      });

      // ===== OTRAS FUNCIONES =====
      function changeImage(pageId, circleId) {
      circleToFill = { pageId, circleId };
      fileInputHidden.value = '';
      fileInputHidden.click();
      }

      function removeImage(pageId, circleId) {
      if (confirm('¬øEliminar esta imagen?')) {
      updateCircle(pageId, circleId, {
      imageData: null,
      scale: 100,
      posX: 50,
      posY: 50,
      locked: false
      });
      }
      }

      function removePage(id) {
      if (pages.length <= 1) return; if (!confirm('¬øEliminar esta hoja completa?')) return; pages=pages.filter(p=> p.id
        !== id).map((p, idx) => ({
        ...p,
        id: idx + 1
        }));
        renderPages();
        closeEditPanel();
        }

        function showPixabayCredit(topic, count) {
        let credit = document.getElementById('pixabay-credit');
        if (!credit) {
        credit = document.createElement('div');
        credit.id = 'pixabay-credit';
        credit.classList.add('no-print');
        const container = document.querySelector('.container');
        container?.insertBefore(credit, container.firstChild);
        }
        const cleanTopic = topic || 'Pixabay';
        credit.textContent = `Im√°genes de Pixabay (${count}) ¬∑ Tema: ${cleanTopic}`;
        }

        function ensurePagesForImages(totalImages) {
        const slotsPerPage = 6;
        const requiredPages = Math.ceil(totalImages / slotsPerPage) || 1;
        while (pages.length < requiredPages) { pages.push(createInitialPageData(pages.length + 1)); } } function
          fillCirclesFromPixabay(urls=[], topic='Pixabay' ) { if (!Array.isArray(urls) || urls.length===0) return;
          ensurePagesForImages(urls.length); let idx=0; pages.forEach((page)=> {
          page.circles.forEach((circle) => {
          const url = urls[idx];
          if (!url) return;

          circle.imageData = url;
          circle.scale = 100;
          circle.posX = 50;
          circle.posY = 50;
          circle.locked = false;

          idx++;
          });
          });

          renderPages();
          showPixabayCredit(topic, urls.length);
          }

          window.addEventListener('message', (event) => {
          const data = event.data;
          if (!data || data.type !== 'ARKAIOS_PIXABAY_IMAGES') return;
          fillCirclesFromPixabay(data.images || [], data.topic || 'Pixabay');
          });

          // Nuclear fix for printing
          window.onbeforeprint = function () {
          const credit = document.getElementById('pixabay-credit');
          if (credit) credit.style.setProperty('display', 'none', 'important');
          };
          window.onafterprint = function () {
          const credit = document.getElementById('pixabay-credit');
          if (credit) credit.style.display = 'block';
          };

          // ===== FIN DEL SCRIPT =====
          </script>
</body>

</html>