<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plantilla de Impresi√≥n de Im√°genes | ARKAIOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .panel-control {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .header h1 {
      color: #667eea;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .controles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .control-group select,
    .control-group input[type="number"] {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      background: white;
    }

    .control-group select:focus,
    .control-group input[type="number"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .botones-accion {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #48bb78;
      color: white;
    }

    .btn-secondary:hover {
      background: #38a169;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
      transform: translateY(-2px);
    }

    .stats {
      display: flex;
      gap: 20px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 8px;
      margin-top: 16px;
    }

    .stat-item {
      flex: 1;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .hojas-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .page-wrapper {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .page-info {
      text-align: center;
      margin-bottom: 16px;
      font-weight: 600;
      color: #667eea;
      font-size: 14px;
    }

    .page-container {
      width: 21.59cm;
      height: 27.94cm;
      background: white;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cuadricula {
      display: grid;
      gap: 0;
    }

    .celda-imagen {
      border: 1px dashed #cbd5e0;
      background: #fafafa;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .celda-imagen:hover {
      border-color: #667eea;
      background: #f7fafc;
    }

    .celda-imagen.dragging {
      opacity: 0.5;
      border: 2px solid #667eea;
    }

    .celda-imagen.drag-over {
      background: #e6f2ff;
      border: 2px solid #667eea;
    }

    .num-celda {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(102, 126, 234, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      z-index: 2;
    }

    .img-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .img-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.3s;
      user-select: none;
    }

    .img-preview.moviendo {
      cursor: move;
    }

    .botones-celda {
      position: absolute;
      bottom: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 3;
    }

    .celda-imagen:hover .botones-celda {
      opacity: 1;
    }

    .btn-celda {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .btn-editar {
      background: #48bb78;
    }

    .btn-editar:hover {
      background: #38a169;
    }

    .btn-fijar {
      background: #4299e1;
    }

    .btn-fijar:hover {
      background: #3182ce;
    }

    .btn-eliminar {
      background: #f56565;
    }

    .btn-eliminar:hover {
      background: #e53e3e;
      transform: translateY(-2px);
    }

    .celda-vacia {
      color: #cbd5e0;
      font-size: 32px;
      font-weight: 300;
    }

    #pixabay-credit {
      margin: 12px auto;
      background: #f8fafc;
      border: 1px solid #d1d5db;
      padding: 10px 14px;
      border-radius: 10px;
      color: #1f2937;
      font-weight: 600;
      max-width: 960px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    }

    .modal-editor {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-editor.activo {
      display: flex;
    }

    .modal-contenido {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      color: #667eea;
      font-size: 20px;
    }

    .btn-cerrar {
      background: #f56565;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .editor-preview {
      width: 100%;
      max-height: 400px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fafafa;
    }

    .editor-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .controles-editor {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .control-zoom {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .control-zoom input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #e0e0e0;
      outline: none;
    }

    .control-zoom input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }

    @media print {
      @page {
        margin: 0;
        size: auto;
      }

      html,
      body {
        background: white;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      /* Ocultar elementos de interfaz y textos no deseados */
      .panel-control,
      .modal-editor,
      #pixabay-credit,
      .no-print,
      #aiModal,
      .page-info,
      .botones-celda,
      .num-celda,
      .celda-vacia {
        display: none !important;
      }

      .hojas-container {
        display: block;
        margin: 0;
        padding: 0;
        gap: 0;
        gap: 0;
      }

      .page-wrapper {
        box-shadow: none;
        padding: 0;
        margin: 0;
        border: none;
        background: transparent;
        width: 100%;
        /* Forzar salto de p√°gina excepto en el √∫ltimo */
        page-break-after: always;
        break-after: page;
        display: flex;
        justify-content: center;
        align-items: start;
      }

      .page-wrapper:last-child {
        page-break-after: auto;
        break-after: auto;
      }

      .page-container {
        box-shadow: none;
        margin: 0;
        border: none;
        overflow: hidden;
        /* Asegurar que no exceda las dimensiones */
        max-width: 100%;
        page-break-inside: avoid;
      }

      .celda-imagen {
        border: 1px solid #000 !important;
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }

      .img-preview {
        max-width: 100%;
        max-height: 100%;
      }
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="panel-control">
      <div class="header">
        <h1>üñºÔ∏è Plantilla de Impresi√≥n de Im√°genes</h1>
        <p>Sube tus im√°genes, ajusta el tama√±o y genera tu PDF listo para imprimir</p>
      </div>

      <div class="controles-grid">
        <div class="control-group">
          <label>üìè Tama√±o de cuadros:</label>
          <select id="selector-tamano">
            <option value="3">3 cm (Pasaporte/Infantil)</option>
            <option value="4">4 cm</option>
            <option value="5" selected>5 cm (Credencial)</option>
            <option value="6">6 cm</option>
            <option value="7">7 cm</option>
            <option value="8">8 cm</option>
            <option value="9">9 cm</option>
            <option value="10">10 cm</option>
          </select>
        </div>

        <div class="control-group">
          <label>üìÇ Agregar im√°genes:</label>
          <input type="file" id="input-imagenes" multiple accept="image/*" style="display: none;">
          <button class="btn btn-primary" onclick="document.getElementById('input-imagenes').click()">
            Seleccionar archivos
          </button>
        </div>
      </div>

      <div class="botones-accion">
        <button class="btn btn-primary" onclick="searchPexels()" style="background: #05a081;">üì∏ Pexels</button>
        <button class="btn btn-primary" onclick="searchFreepik()" style="background: #336aea;">üé® Freepik</button>
        <button class="btn btn-primary" onclick="openAIModal()" style="background: #8e44ad;">‚ú® Crear con IA</button>
        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Imprimir hojas</button>
        <button class="btn btn-danger" onclick="limpiarTodo()">üóëÔ∏è Limpiar todo</button>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="stat-imagenes">0</div>
          <div class="stat-label">Im√°genes</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-hojas">0</div>
          <div class="stat-label">Hojas</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-cuadros">0</div>
          <div class="stat-label">Cuadros/Hoja</div>
        </div>
      </div>
    </div>

    <div id="hojas-container" class="hojas-container">
      <!-- Las hojas se generar√°n aqu√≠ -->
    </div>
  </div>

  <!-- Input oculto para cambios individuales -->
  <input type="file" id="input-individual" accept="image/*" style="display: none;">

  <!-- Modal Editor -->
  <div id="modal-editor" class="modal-editor">
    <div class="modal-contenido">
      <div class="modal-header">
        <h3>‚úèÔ∏è Editar Imagen</h3>
        <button class="btn-cerrar" onclick="cerrarEditor()">‚úï Cerrar</button>
      </div>
      <div class="editor-preview" id="editor-preview">
        <img id="editor-img" src="" alt="">
      </div>
      <div class="controles-editor">
        <div class="control-zoom">
          <label>üîç Zoom:</label>
          <input type="range" id="zoom-slider" min="100" max="200" value="100" step="1">
          <span class="zoom-valor" id="zoom-valor">100%</span>
        </div>
        <button class="btn btn-primary" onclick="aplicarEdicion()">‚úì Aplicar cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal IA -->
  <div id="aiModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div
      style="background: #1f2937; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid #3b82f6;">
      <h3 style="color: #3b82f6; margin-bottom: 15px;">‚ú® Generar Imagen con Grok</h3>

      <div style="margin-bottom: 15px;">
        <label style="display: block; color: #e5e7eb; margin-bottom: 5px;">Tu API Key de Grok (xAI):</label>
        <input type="password" id="grokKey" placeholder="xai-..."
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #4b5563; background: #374151; color: white;">
        <small style="color: #9ca3af;">Se guardar√° localmente en tu navegador.</small>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; color: #e5e7eb; margin-bottom: 5px;">Describe tu imagen:</label>
        <textarea id="aiPrompt" rows="4" placeholder="Un paisaje espacial con planetas coloridos..."
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #4b5563; background: #374151; color: white;"></textarea>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; color: #e5e7eb; margin-bottom: 5px;">N√∫mero de im√°genes:</label>
        <input type="number" id="imageCount" min="1" max="4" value="1"
          style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #4b5563; background: #374151; color: white;">
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeAIModal()"
          style="background: #4b5563; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Cancelar</button>
        <button onclick="generateAIImage()"
          style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Generar
          con Grok</button>
      </div>

      <div id="aiStatus" style="margin-top: 10px; color: #e5e7eb; font-size: 0.9rem;"></div>
    </div>
  </div>

  <script>
    const inputImagenes = document.getElementById('input-imagenes');
    const inputIndividual = document.getElementById('input-individual');
    const hojasContainer = document.getElementById('hojas-container');
    const selectorTamano = document.getElementById('selector-tamano');

    // Editor
    const modalEditor = document.getElementById('modal-editor');
    const editorImg = document.getElementById('editor-img');
    const zoomSlider = document.getElementById('zoom-slider');
    const zoomValor = document.getElementById('zoom-valor');

    let imagenes = [];
    let estadosImagen = []; // { zoom: 100, x: 0, y: 0, fijada: false }
    let indiceEditando = -1;
    let indiceDragInicio = -1;

    // ===== API KEYS & INTEGRATION =====
    const PEXELS_API_KEY = '4vj6qTzLM9oc0gN7bdgr3vCO7jRDIBe0zJgknfq9geibx9hdQ16TVxpz';
    const FREEPIK_API_KEY = 'FPSX890e70b7164ab7a1b05182a68d64ad06';

    function applyExternalImages(urls, sourceName) {
      rellenarConPixabay(urls, sourceName);
    }

    async function searchPexels() {
      const query = prompt("¬øQu√© im√°genes buscas en Pexels?");
      if (!query) return;

      try {
        const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=12`, {
          headers: { Authorization: PEXELS_API_KEY }
        });
        const data = await response.json();
        const images = data.photos.map(photo => photo.src.large);
        applyExternalImages(images, `Pexels: ${query}`);
      } catch (error) {
        console.error(error);
        alert('Error al buscar en Pexels');
      }
    }

    async function searchFreepik() {
      const query = prompt("¬øQu√© im√°genes buscas en Freepik?");
      if (!query) return;

      try {
        const response = await fetch(`https://api.freepik.com/v1/resources?locale=es-ES&q=${encodeURIComponent(query)}&limit=12`, {
          headers: { 'X-Freepik-API-Key': FREEPIK_API_KEY }
        });
        const data = await response.json();
        const images = data.data.map(item => item.image.source.url);
        applyExternalImages(images, `Freepik: ${query}`);
      } catch (error) {
        console.error(error);
        alert('Error al buscar en Freepik');
      }
    }

    // ===== AI GENERATION =====
    function openAIModal() {
      const storedKey = localStorage.getItem('grok_api_key');
      if (storedKey) document.getElementById('grokKey').value = storedKey;
      document.getElementById('aiModal').style.display = 'flex';
    }

    function closeAIModal() {
      document.getElementById('aiModal').style.display = 'none';
      document.getElementById('aiStatus').textContent = '';
    }

    async function generateAIImage() {
      const apiKey = document.getElementById('grokKey').value.trim();
      const prompt = document.getElementById('aiPrompt').value.trim();
      const count = parseInt(document.getElementById('imageCount').value) || 1;
      const statusDiv = document.getElementById('aiStatus');

      if (!apiKey) {
        alert('Por favor ingresa tu API Key de Grok (xAI)');
        return;
      }
      if (!prompt) {
        alert('Por favor describe la imagen');
        return;
      }

      localStorage.setItem('grok_api_key', apiKey);
      statusDiv.textContent = '‚è≥ Generando im√°genes con Grok... (esto puede tomar unos segundos)';

      try {
        const response = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            messages: [
              {
                role: 'system',
                content: 'You are an advanced AI capable of generating images. When asked to generate an image, provide the direct URL to the generated image in your response. If you cannot generate an image directly, explain why.'
              },
              {
                role: 'user',
                content: `Generate ${count} image(s) of: ${prompt}. Return only the image URLs.`
              }
            ],
            model: 'grok-beta',
            stream: false,
            temperature: 0.7
          })
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData.error?.message || response.statusText);
        }

        const data = await response.json();
        const content = data.choices[0]?.message?.content || '';

        // Buscar URLs en la respuesta
        const urlRegex = /(https?:\/\/[^\s)]+)/g;
        const matches = content.match(urlRegex);

        if (!matches || matches.length === 0) {
          throw new Error('Grok no devolvi√≥ URLs de im√°genes. Respuesta: ' + content.substring(0, 100) + '...');
        }

        const imageUrls = matches.slice(0, count);
        applyExternalImages(imageUrls, `Grok: ${prompt}`);
        closeAIModal();

      } catch (error) {
        console.error(error);
        statusDiv.textContent = '‚ùå Error: ' + error.message;
      }
    }

    // Event Listeners
    selectorTamano.addEventListener('change', generarPlantilla);

    inputImagenes.addEventListener('change', function (e) {
      const archivos = Array.from(e.target.files);
      let cargados = 0;

      archivos.forEach(archivo => {
        const reader = new FileReader();
        reader.onload = function (ev) {
          imagenes.push(ev.target.result);
          estadosImagen.push({ zoom: 100, x: 0, y: 0, fijada: false });
          cargados++;
          if (cargados === archivos.length) {
            generarPlantilla();
          }
        };
        reader.readAsDataURL(archivo);
      });
      e.target.value = '';
    });

    inputIndividual.addEventListener('change', function (e) {
      const archivo = e.target.files[0];
      if (!archivo) return;

      const reader = new FileReader();
      reader.onload = function (ev) {
        if (indiceEditando >= 0) {
          imagenes[indiceEditando] = ev.target.result;
          estadosImagen[indiceEditando] = { zoom: 100, x: 0, y: 0, fijada: false };
          generarPlantilla();
        }
      };
      reader.readAsDataURL(archivo);
      e.target.value = '';
    });

    function generarPlantilla() {
      hojasContainer.innerHTML = '';
      const tamano = parseInt(selectorTamano.value);
      const filas = Math.floor(27.94 / tamano);
      const cols = Math.floor(21.59 / tamano);
      const cuadrosPorHoja = filas * cols;
      const hojasNecesarias = Math.max(1, Math.ceil(imagenes.length / cuadrosPorHoja));

      actualizarEstadisticas(imagenes.length, hojasNecesarias, cuadrosPorHoja);

      for (let h = 0; h < hojasNecesarias; h++) {
        const pageWrapper = document.createElement('div');
        pageWrapper.className = 'page-wrapper';

        const pageInfo = document.createElement('div');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Hoja ${h + 1} de ${hojasNecesarias}`;
        pageWrapper.appendChild(pageInfo);

        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';

        const cuadricula = document.createElement('div');
        cuadricula.className = 'cuadricula';
        cuadricula.style.gridTemplateColumns = `repeat(${cols}, ${tamano}cm)`;
        cuadricula.style.gridTemplateRows = `repeat(${filas}, ${tamano}cm)`;

        const inicio = h * cuadrosPorHoja;
        const fin = Math.min(inicio + cuadrosPorHoja, imagenes.length);

        for (let i = 0; i < cuadrosPorHoja; i++) {
          const idx = inicio + i;
          const celda = crearCelda(idx, tamano);
          cuadricula.appendChild(celda);
        }

        pageContainer.appendChild(cuadricula);
        pageWrapper.appendChild(pageContainer);
        hojasContainer.appendChild(pageWrapper);
      }
    }

    function crearCelda(idx, tamano) {
      const celda = document.createElement('div');
      celda.className = 'celda-imagen arkaios-image-slot';
      celda.style.width = `${tamano}cm`;
      celda.style.height = `${tamano}cm`;
      celda.draggable = imagenes[idx] ? true : false;
      celda.dataset.idx = idx;

      const numCelda = document.createElement('span');
      numCelda.className = 'num-celda';
      numCelda.textContent = idx + 1;
      celda.appendChild(numCelda);

      if (imagenes[idx]) {
        const imgContainer = document.createElement('div');
        imgContainer.className = 'img-container';

        const img = document.createElement('img');
        img.src = imagenes[idx];
        img.className = 'img-preview';

        const estado = estadosImagen[idx] || { zoom: 100, x: 0, y: 0, fijada: false };
        img.style.transform = `scale(${estado.zoom / 100})`;

        imgContainer.appendChild(img);
        celda.appendChild(imgContainer);

        const botones = document.createElement('div');
        botones.className = 'botones-celda';

        const btnEditar = document.createElement('button');
        btnEditar.className = 'btn-celda btn-editar';
        btnEditar.textContent = '‚úèÔ∏è';
        btnEditar.onclick = (e) => {
          e.stopPropagation();
          abrirEditor(idx);
        };

        const btnFijar = document.createElement('button');
        btnFijar.className = 'btn-celda btn-fijar';
        btnFijar.textContent = estado.fijada ? 'üîì' : 'üìå';
        btnFijar.onclick = (e) => {
          e.stopPropagation();
          toggleFijar(idx);
        };

        const btnEliminar = document.createElement('button');
        btnEliminar.className = 'btn-celda btn-eliminar';
        btnEliminar.textContent = 'üóëÔ∏è';
        btnEliminar.onclick = (e) => {
          e.stopPropagation();
          eliminarImagen(idx);
        };

        botones.appendChild(btnEditar);
        botones.appendChild(btnFijar);
        botones.appendChild(btnEliminar);
        celda.appendChild(botones);

        celda.addEventListener('dragstart', handleDragStart);
        celda.addEventListener('dragover', handleDragOver);
        celda.addEventListener('drop', handleDrop);
        celda.addEventListener('dragend', handleDragEnd);
      } else {
        const icono = document.createElement('span');
        icono.className = 'celda-vacia';
        icono.textContent = '+';
        celda.appendChild(icono);
        celda.onclick = function () {
          indiceEditando = idx;
          inputIndividual.click();
        };
      }

      return celda;
    }

    function handleDragStart(e) {
      const idx = parseInt(e.currentTarget.dataset.idx);
      if (estadosImagen[idx]?.fijada) {
        e.preventDefault();
        return;
      }
      indiceDragInicio = idx;
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      const idxDestino = parseInt(e.currentTarget.dataset.idx);

      if (indiceDragInicio !== -1 && indiceDragInicio !== idxDestino) {
        const temp = imagenes[indiceDragInicio];
        const tempEstado = estadosImagen[indiceDragInicio];
        imagenes[indiceDragInicio] = imagenes[idxDestino];
        estadosImagen[indiceDragInicio] = estadosImagen[idxDestino];
        imagenes[idxDestino] = temp;
        estadosImagen[idxDestino] = tempEstado;
        generarPlantilla();
      }
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
      indiceDragInicio = -1;
    }

    function abrirEditor(idx) {
      indiceEditando = idx;
      editorImg.src = imagenes[idx];
      const estado = estadosImagen[idx] || { zoom: 100 };
      zoomSlider.value = estado.zoom;
      zoomValor.textContent = estado.zoom + '%';
      editorImg.style.transform = `scale(${estado.zoom / 100})`;
      modalEditor.classList.add('activo');
    }

    function cerrarEditor() {
      modalEditor.classList.remove('activo');
      indiceEditando = -1;
    }

    zoomSlider.addEventListener('input', function () {
      const zoom = parseInt(this.value);
      zoomValor.textContent = zoom + '%';
      editorImg.style.transform = `scale(${zoom / 100})`;
    });

    function aplicarEdicion() {
      if (indiceEditando >= 0) {
        estadosImagen[indiceEditando].zoom = parseInt(zoomSlider.value);
        generarPlantilla();
        cerrarEditor();
      }
    }

    function toggleFijar(idx) {
      if (!estadosImagen[idx]) {
        estadosImagen[idx] = { zoom: 100, x: 0, y: 0, fijada: false };
      }
      estadosImagen[idx].fijada = !estadosImagen[idx].fijada;
      generarPlantilla();
    }

    function eliminarImagen(idx) {
      if (confirm('¬øEliminar esta imagen?')) {
        imagenes.splice(idx, 1);
        estadosImagen.splice(idx, 1);
        generarPlantilla();
      }
    }

    function limpiarTodo() {
      if (confirm('¬øEliminar todas las im√°genes?')) {
        imagenes = [];
        estadosImagen = [];
        generarPlantilla();
      }
    }

    function actualizarEstadisticas(numImagenes, numHojas, cuadrosPorHoja) {
      document.getElementById('stat-imagenes').textContent = numImagenes;
      document.getElementById('stat-hojas').textContent = numHojas;
      document.getElementById('stat-cuadros').textContent = cuadrosPorHoja;
    }

    function mostrarCreditoPixabay(topic, count) {
      let credit = document.getElementById('pixabay-credit');
      if (!credit) {
        credit = document.createElement('div');
        credit.id = 'pixabay-credit';
        credit.classList.add('no-print');
        const container = document.querySelector('.container');
        container?.insertBefore(credit, container.firstChild);
      }
      const cleanTopic = topic || 'Pixabay';
      credit.textContent = `Im√°genes de Pixabay (${count}) ¬∑ Tema: ${cleanTopic}`;
    }

    function rellenarConPixabay(urls = [], topic = 'Pixabay') {
      if (!Array.isArray(urls) || urls.length === 0) return;
      imagenes = urls.slice();
      estadosImagen = imagenes.map(() => ({ zoom: 100, x: 0, y: 0, fijada: false }));
      generarPlantilla();
      mostrarCreditoPixabay(topic, urls.length);
    }

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || data.type !== 'ARKAIOS_PIXABAY_IMAGES') return;
      rellenarConPixabay(data.images || [], data.topic || 'Pixabay');
    });

    // Nuclear fix for printing
    window.onbeforeprint = function () {
      const credit = document.getElementById('pixabay-credit');
      if (credit) credit.style.setProperty('display', 'none', 'important');
    };
    window.onafterprint = function () {
      const credit = document.getElementById('pixabay-credit');
      if (credit) credit.style.display = 'block';
    };

    // Iniciar
    generarPlantilla();
  </script>
</body>

</html>